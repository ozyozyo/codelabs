
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Build Actions for Google Assistant with Daily Updates / Push Notifications (Japanese)</title>
  <script src="./bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <link rel="import" href="./elements/codelab.html">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <style is="custom-style">
    body {
      font-family: "Roboto",sans-serif;
      background: var(--google-codelab-background, #F8F9FA);
    }
  </style>
  
</head>
<body unresolved class="fullbleed">

  <google-codelab title="Build Actions for Google Assistant with Daily Updates / Push Notifications (Japanese)"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="Overview" duration="2">
        <p>Actions on Googleは、スマートスピーカー、携帯電話、車、テレビ、ヘッドフォンなど、5億以上のデバイスにわたって、Googleの仮想パーソナルアシスタントであるGoogleアシスタントの機能を拡張するためのソフトウェアを作成できる、開発者向けプラットフォームです。</p>
<p>ユーザーは、食料品の購入や乗車予約など、何かを達成するためにGoogleアシスタントを会話に加えることができます（現在の機能の完全なリストについては、アクションディレクトリをご覧ください）。開発者は、Actions on Googleを使用して、ユーザーとサードパーティのフルフィルメントサービスとの間の楽しく効果的な会話体験を簡単に作成し活用することができます。</p>
<p>このコードラボでは、Actions on Googleを使った基本的なアクションを開発します。そして、そのアクションに対して、Daily UpdatesやPush Notificationsを使った、よりリッチな体験を追加します。</p>
<p>このコードラボは、Actions on GoogleおよびDialogflowを使用した基本的なアクションの開発方法についての詳細な説明は行いません。一般的なアクションの開発方法については、<a href="https://codelabs.developers.google.com/codelabs/actions-1-ja/#0" target="_blank">Build Actions for the Google Assistant (Level 1)</a> や <a href="https://codelabs.developers.google.com/codelabs/actions-2-ja/index.html#0" target="_blank">Build Actions for the Google Assistant (Level 2)</a> を参照ください。</p>
<h2><strong>何をつくりますか？</strong></h2>
<p>このコードラボでは、次の機能を備えた対話アクションを作成します。</p>
<ul>
<li>ユーザーは、明示的にアクションを名前で呼び出すことによって会話を開始することができます。</li>
<li>会話に入ると、ユーザは最近起きたニュースや、特定の日付のニュースをアクションに問い合わせます。アクションは指定された条件に一致するニュースを読み上げます。</li>
<li>ユーザが「毎日ニュースを受け取る」とアクションに話しかけると、アクションはDaily Updates機能を呼び出します。Googleアシスタントはユーザに「何時にニュースを受け取るか」を問い合わせます。ユーザが希望する時間を指定することで通知登録が完了し、会話が終了します。</li>
<li>ユーザが「リアルタイムにニュースを受け取る」とアクションに話しかけると、アクションはPush Notification機能を呼び出します。Googleアシスタントはユーザに通知の送信を許可するかどうか問い合わせます。ユーザが許可することで通知登録が完了し、会話が終了します。</li>
<li>ユーザにPush Notificationを送信するコードを作成し、実際に通知を送ります。</li>
</ul>
<p><img style="max-width: 602.00px" src="img/62db770ce6eca64.png"></p>
<h2 class="checklist"><strong>What you&#39;ll learn</strong></h2>
<ul class="checklist">
<li>Daily Updates機能を使った定期的な通知処理の登録方法。</li>
<li>Push Notifications機能を使ったリアルタイムな通知の送信方法。</li>
</ul>
<h2><strong>必要なもの</strong></h2>
<p>以下のツールがあなたの環境に必要となります。</p>
<ul>
<li><a href="https://www.google.com/chrome/" target="_blank">Chrome</a> ウェブブラウザ。</li>
<li>Android スマートフォン。または「<a href="https://itunes.apple.com/jp/app/google-%E3%82%A2%E3%82%B7%E3%82%B9%E3%82%BF%E3%83%B3%E3%83%88/id1220976145?mt=8" target="_blank">Googleアシスタント</a>」アプリがインストールされた iPhone スマートフォン。</li>
<li>NodeJS Version 6, 8, 10 のいずれかの最新バージョン。</li>
<li>インストールされているNodeJS、npmを使ってシェルコマンドを実行するためのターミナル。</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Design a conversation" duration="4">
        <p>Daily UpdatesやPush Notificationsといった機能を解説する前に、まずは土台となるアクションを準備しましょう。このコードラボでは、「デイリーニュース」アクションを作ります。「デイリーニュース」アクションが提供する機能は、以下とします。</p>
<ul>
<li>ユーザがアクションを呼び出すと、アクションはいつのニュースを知りたいかを聞いてきます。</li>
<li>ユーザが「最近のニュース」と言うと、アクションは24時間以内に起きたニュースを伝えます。</li>
<li>ユーザが「今日のニュース」や「9月22日のニュース」というように特定の日付を言った場合は、アクションはその日に起きたニュースを伝えます。</li>
<li>ユーザが「最新のニュース」と言うと、アクションは最も最近に起きたニュースを1件伝えます。</li>
<li>ユーザは「さようなら」というような言葉により、いつでも会話を終えることができます。</li>
</ul>
<p>具体的には、以下のような会話を想定します。このままでは十分なニュースサービスとは言えませんが、コードラボのサンプルアクションとしては十分です。</p>
<p><img style="max-width: 324.00px" src="img/e93fc3a969c98272.png"></p>
<p>この会話は、ユーザからアクションに対して問いかけを続けていくことで対話が進みます。このコードラボでは、後ほど以下の問いかけについて、通知をサポートします。</p>
<ul>
<li>「最近のニュース」をDaily Updatesにより毎日指定の時間に通知が来るようにします。</li>
<li>「最新のニュース」をPush Notificationsによりリアルタイムで通知が来るようにします。</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Setup a project" duration="9">
        <p>アクションを作成するには、Actions Projectを作成し、アクションごとに2つの内容（インテントとフルフィルメント）を定義します。</p>
<aside class="special"><p><strong>Actions on Googleにおけるキーとなる用語:</strong></p>
<ul>
<li><strong>Actions project:</strong> アクションのコレクションを管理、テスト、そして公開するためにあなたが作成するプロジェクトです。Googleは、あなたのアクションプロジェクトをクラウドバックエンドにて運用します。</li>
<li><strong>Actions Console:</strong> あなたのアクション開発を容易にするためのGoogleが提供するウェブベースのツールです。あなたは、コンソールを使って、あなたのアクションを作成、メンテナンス、テスト、そして公開することができます。</li>
</ul>
</aside>
<p>コードラボのこのセクションでは、Actions ConsoleでActions projectを設定する方法について説明します。</p>
<h2><strong>Googleの権限設定を確認する</strong></h2>
<p>このコードラボで作成するアクションをテストするには、必要な権限を有効にする必要があります。</p>
<ol type="1" start="1">
<li>&#34;Activity Controls&#34; ページに行きます (<a href="https://myaccount.google.com/activitycontrols" target="_blank">https://myaccount.google.com/activitycontrols</a>)。</li>
<li>サインインされていなければ、あなたのGoogleアカウントでサインインします。</li>
<li>以下の権限を有効にします。</li>
</ol>
<ul>
<li>Web &amp; App Activity</li>
<li>Device Information</li>
<li>Voice &amp; Audio Activity</li>
</ul>
<h2><strong>Actions projectを作成する</strong></h2>
<p>Actions projectは、<a href="https://assistant.google.com/explore" target="_blank">Actions directory</a> のリストに掲載されるメタデータ（名前、説明、カテゴリ）を持つあなたのアクションのコンテナです。</p>
<p>アクションの構築を開始するには、まず以下のようにActions projectを作成します。</p>
<ol type="1" start="1">
<li><a href="https://console.actions.google.com/" target="_blank">Actions Console</a> を開きます。</li>
<li><strong>Add/import project</strong> をクリックします。</li>
<li>&#34;daily-news-codelab&#34; のように、<strong>Project name </strong>を入力します。この名前は、内部参照用です。あとで、あなたはこのプロジェクト向けに外部用の名前をセットすることができます。また、言語と国については、それぞれ &#34;Japanese&#34; および &#34;Japan&#34; を選択してください。</li>
</ol>
<p><img style="max-width: 602.00px" src="img/13be51f353f9bae7.png"></p>
<aside class="warning"><p>ここで言語と国の選択を間違えてしまうと、後で作成したアクションを呼び出すことができません。必ず &#34;Japanese&#34; および &#34;Japan&#34; を選択してください。</p>
</aside>
<ol type="1" start="4">
<li><strong>Create Project</strong> をクリックします。</li>
<li>カテゴリを選択するのではなく、右上隅にある <strong>Skip</strong> をクリックします。</li>
</ol>
<p><img style="max-width: 602.00px" src="img/108b2a42e0be50ef.png"></p>
<ol type="1" start="6">
<li>左のナビにある <strong>Build &gt; Actions</strong> をクリックします。</li>
<li><strong>Add your first Action</strong> をクリックします。</li>
<li><strong>Custom intent</strong> カード上で、<strong>Build</strong> をクリックします。もう一つのタブで、Dialogflow Consoleが開くでしょう。</li>
</ol>
<p><img style="max-width: 602.00px" src="img/dfb2632da74c4e7e.png"></p>
<h2><strong>Dialogflowエージェントを作成する</strong></h2>
<p>Actions projectを作成したら、Dialogflowエージェントを作成して、あなたのプロジェクトに関連付けを行います:</p>
<ol type="1" start="1">
<li>上記の手順を実行した後、上部にActions projectの名前が表示されているDialogflow Consoleに、既にあなたはいるはずです。あなたのGoogleアカウントを使用するようにDialogflowを承認し、利用規約に同意する必要があります。</li>
</ol>
<aside class="warning"><p>Dialogflowコンソールの中にいないですか？ &#34;Actions projectを作成する&#34; セクションのすべての手順を完了していることを確認してください。まだDialogflow Consoleを見ることができませんか？そのときは、Dialogflow Consoleにナビゲートし、左側のナビゲーションで <strong>Create new agent </strong>を選択することができます。</p>
</aside>
<ol type="1" start="2">
<li><strong>DEFAULT LANGUAGE</strong>を &#34;Japanese - ja&#34; に変更します。また、 <strong>DEFAULT TIME ZONE</strong> が &#34;Asia/Tokyo&#34; になっていることを確認します。そして、<strong>Create</strong> をクリックします。</li>
</ol>
<p><img style="max-width: 602.00px" src="img/9e2504787222464b.png"></p>
<p>エージェントの作成が成功した場合は、<strong>Intents</strong> ページに移動します。あなたは、Dialogflowエージェントがユーザーの要求にどのように応答するかをカスタマイズできるようになりました。</p>


      </google-codelab-step>
    
      <google-codelab-step label="Create a conversation" duration="15">
        <p>では、先ほど作成したDialogflowエージェントを使って、会話を定義していきましょう。このコードラボでは、以下のインテントを定義することで、デイリーニュースアクションの会話を組み立てます。</p>
<ul>
<li>&#34;Default Welcome Intent&#34; - 会話の起点となるウェルカムインテントです。</li>
<li>&#34;Quit&#34; - 会話終えるインテントです。</li>
<li>&#34;Recent News&#34; - 最近（24時間以内）のニュースを得るインテントです。</li>
<li>&#34;Past News&#34; - 指定日付のニュースを得るインテントです。</li>
<li>&#34;Latest News&#34; - 最新のニュースを得るインテントです。</li>
</ul>
<h2><strong>ウェルカムインテントを変更する</strong></h2>
<p>すべてのActions projectには、ユーザが会話を開始するためのエントリポイントとして機能するウェルカムインテントが必要です。ウェルカムインテントは、ユーザがアクション名を発声して明示的にアクションを呼び出すときにトリガーされます。</p>
<p>デフォルトでは、Dialogflowは私たちのためにウェルカムインテントを作成しています。このコードラボでは、ユーザーが &#34;テスト用アプリにつないで&#34; と発言したときにトリガーされるウェルカムインテントを変更します。</p>
<p>以下の手順に従って、ウェルカムインテントを修正します。</p>
<ol type="1" start="1">
<li>Dialogflow Consoleの <strong>Intents</strong> ページにて、<strong>Default Welcome Intent</strong> をクリックします。</li>
</ol>
<p><img style="max-width: 602.00px" src="img/43b35adaa6e319ff.png"></p>
<ol type="1" start="2">
<li>下にある <strong>Fulfillment </strong>をクリックして、フルフィルメントを設定するためのUIを表示します。そして、<strong>Enable webhook call for this intent</strong> を ON にします。</li>
</ol>
<p><img style="max-width: 602.00px" src="img/bcbe270d472eed58.png"></p>
<aside class="special"><p><strong>Tip: Enable webhook call for this intent</strong> を ON にすることで、そのインテントが呼び出された後のユーザへの返事の内容は、フルフィルメントが決定することになります。</p>
</aside>
<ol type="1" start="3">
<li>上にある <strong>SAVE</strong> ボタンを押して、変更内容を保存します。</li>
</ol>
<h2><strong>Quitインテントの作成</strong></h2>
<p>ユーザが会話を終えたい際の Quit インテントを作成します。Dialogflowに対して以下の操作を行ってください。</p>
<ol type="1" start="1">
<li>左のナビゲーションメニューにある <strong>Intents</strong> メニュー項目の右にある<strong>＋</strong>アイコンをクリックします。</li>
</ol>
<p><img style="max-width: 602.00px" src="img/933581e6062ec3d3.png"></p>
<ol type="1" start="2">
<li><strong>Intent name</strong> に &#34;Quit&#34; と入力します。</li>
<li><strong>Training phrases</strong> に &#34;さようなら&#34; と入力し、ENTER キーを押します。</li>
<li><strong>Responses</strong> の <strong>Text Response</strong> に &#34;また会いましょう。&#34; と入力し、ENTER キーを押します。そして、<strong>Set this intent as end of conversation</strong> を ON にします。</li>
</ol>
<p><img style="max-width: 602.00px" src="img/9e6b1369fecfc5b9.png"></p>
<aside class="special"><p><strong>Tip:</strong> Quit インテントは、フルフィルメントを呼び出すことなく、&#34;また会いましょう。&#34; という返事と共に会話を終了します。そのために、<strong>Set this intent as end of conversation</strong> を ON にしています。</p>
</aside>
<ol type="1" start="5">
<li>上にある <strong>SAVE</strong> ボタンを押して、変更内容を保存します。</li>
</ol>
<h2><strong>Recent Newsインテントの作成</strong></h2>
<p>ここから、ユーザが希望するニュースの条件を指定するためのインテントを作成しましょう。まず、24時間以内に起きた最近のニュースを希望する Recent News インテントを作成します。Dialogflowにて以下の操作を行ってください。</p>
<ol type="1" start="1">
<li>左のナビゲーションメニューにある <strong>Intents</strong> メニュー項目の右にある<strong>＋</strong>アイコンをクリックします。</li>
<li><strong>Intent name</strong> に &#34;Recent News&#34; と入力します。</li>
<li><strong>Training phrases</strong> に以下を入力します。</li>
</ol>
<ul>
<li>&#34;最近&#34;</li>
<li>&#34;最近のニュース&#34;</li>
<li>&#34;最近のニュースを聞きたい&#34;</li>
<li>&#34;最近のニュースを知りたい&#34;</li>
</ul>
<p><img style="max-width: 602.00px" src="img/6e0fbc541c95fd0f.png"></p>
<ol type="1" start="4">
<li>下にある <strong>Fulfillment </strong>をクリックして、フルフィルメントを設定するためのUIを表示します。そして、<strong>Enable webhook call for this intent</strong> を ON にします。</li>
<li>上にある <strong>SAVE</strong> ボタンを押して、変更内容を保存します。</li>
</ol>
<h2><strong>Past Newsインテントの作成</strong></h2>
<p>次に、ユーザが指定した日付のニュースを希望する Past News インテントを作成します。Dialogflowにて以下の操作を行ってください。</p>
<ol type="1" start="1">
<li>左のナビゲーションメニューにある <strong>Intents</strong> メニュー項目の右にある<strong>＋</strong>アイコンをクリックします。</li>
<li><strong>Intent name</strong> に &#34;Past News&#34; と入力します。</li>
<li><strong>Training phrases</strong> に &#34;今日のニュース&#34; と入力し、ENTER キーを押します。</li>
</ol>
<p>これにより、Dialogflowは &#34;今日の&#34; の部分が日付だと自動的に認識します。そして、日付を示す @sys.date というシステムエンティティの <code>date</code> パラメータが割り当てられます。</p>
<p><img style="max-width: 602.00px" src="img/581d5f36ba8bb54d.png"></p>
<aside class="special"><p><strong>キーとなる用語:</strong></p>
<ul>
<li><strong>Entities (Dialogflow):</strong> 物のカテゴリを表します。 Dialogflowにはシステムエンティティのカタログが付属しています（たとえば、&#34;color&#34; と &#34;date&#34; はDialogflowが &#34;それについて知っている&#34; エンティティです）。しかし、開発者はドメイン固有の単語やフレーズのためのカスタムエンティティを定義することができます。 Dialogflowは、自然言語入力からパラメータ値を抽出するために、エンティティを使用します。</li>
</ul>
</aside>
<ol type="1" start="4">
<li>&#34;今日のニュース&#34; だけでなく、<strong>Training phrases</strong> に以下を追加します。</li>
</ol>
<ul>
<li>&#34;今日&#34;</li>
<li>&#34;今日のニュースを教えて&#34;</li>
<li>&#34;今日のニュースを知りたい&#34;</li>
</ul>
<ol type="1" start="5">
<li>下にある <strong>Fulfillment </strong>をクリックして、フルフィルメントを設定するためのUIを表示します。そして、<strong>Enable webhook call for this intent</strong> を ON にします。</li>
<li>上にある <strong>SAVE</strong> ボタンを押して、変更内容を保存します。</li>
</ol>
<h2><strong>Latest Newsインテントの作成</strong></h2>
<p>最後に、最新のニュースを希望する Latest News インテントを作成します。Dialogflowにて以下の操作を行ってください。</p>
<ol type="1" start="1">
<li>左のナビゲーションメニューにある <strong>Intents</strong> メニュー項目の右にある<strong>＋</strong>アイコンをクリックします。</li>
<li><strong>Intent name</strong> に &#34;Latest News&#34; と入力します。</li>
<li><strong>Training phrases</strong> に以下を入力します。</li>
</ol>
<ul>
<li>&#34;最新のニュース&#34;</li>
<li>&#34;最新&#34;</li>
</ul>
<p><img style="max-width: 602.00px" src="img/745ae4f220af78d5.png"></p>
<ol type="1" start="4">
<li>下にある <strong>Fulfillment </strong>をクリックして、フルフィルメントを設定するためのUIを表示します。そして、<strong>Enable webhook call for this intent</strong> を ON にします。</li>
<li>上にある <strong>SAVE</strong> ボタンを押して、変更内容を保存します。</li>
</ol>
<p>以上でデイリーニュースアクションの基本的なインテントの作成は完了です。しかし、まだデイリーニュースアクションとの会話を行うことはできません。</p>


      </google-codelab-step>
    
      <google-codelab-step label="Write a fulfillment code" duration="15">
        <p>先ほど、いくつかのインテントを作成しましたが、そのほとんどはフルフィルメントの呼び出しを ON に設定しました。ここでは、フルフィルメントのコードを作成します。</p>
<h2><strong>フルフィルメントを構築する</strong></h2>
<p>フルフィルメントは、Webhookで呼び出されるプログラムコードです。このコードラボでは、Webhookを構築してデプロイするために、Dialogflow Console の<a href="https://dialogflow.com/docs/how-tos/getting-started-fulfillment" target="_blank">インラインエディタ</a>を使います。あなたのアクションにwebhookを構築するために、以下を行います:</p>
<ol type="1" start="1">
<li>左のナビゲーションから、<strong>Fulfillment</strong> をクリックします。</li>
<li><strong>Inline Editor</strong> のトグルを <strong>DISABLED</strong> から <strong>ENABLED</strong> にします。これにより、インラインエディタが利用可能になります。</li>
</ol>
<p><img style="max-width: 602.00px" src="img/52c79eee03e2698a.png"></p>
<ol type="1" start="3">
<li><strong>index.js</strong> ファイルが選択されていることを確認して、インラインエディタ内を以下の内容で置き換えます。</li>
</ol>
<h3><strong>index.js</strong></h3>
<pre><code>&#34;use strict&#34;;

const functions = require(&#34;firebase-functions&#34;);
const {
    dialogflow,
    Suggestions,
    RegisterUpdate,
    UpdatePermission
} = require(&#34;actions-on-google&#34;);

// SDKの利用準備
const app = dialogflow({
    debug: true
});

// &#34;Default Welcome Intent&#34;を処理するハンドラ関数の登録

// 指定範囲のニュース一覧取得関数

// 返事をする関数

// &#34;Recent News&#34;を処理するハンドラ関数の登録

// &#34;Past News&#34;を処理するハンドラ関数の登録

// &#34;Latest News&#34;を処理するハンドラ関数の登録

// &#34;Setup Daily Updates&#34;を処理するハンドラ関数の登録

// &#34;Finish Daily Updates Setup&#34;を処理するハンドラ関数の登録

// &#34;Setup Push Notifications&#34;を処理するハンドラ関数の登録

// &#34;Finish Push Notifications Setup&#34;を処理するハンドラ関数の登録

// SDKをFirebase Functionsとして登録
exports.dialogflowFirebaseFulfillment = functions.https.onRequest(app);</code></pre>
<ol type="1" start="4">
<li><strong>Deploy</strong> をクリックします。DialogflowがあなたのWebhookコードを準備してデプロイするために、このページで数分待つ必要があるでしょう。コードが正常にデプロイされると、Deploy ボタンの隣にある &#34;Last deployed&#34; タイムスタンプが更新されるのがわかります。</li>
</ol>
<h2><strong>コードを理解する</strong></h2>
<p>Webhookのためのこのコードは、<a href="https://www.javascript.com/" target="_blank">JavaScript</a>で実装されています。Dialogflowのインラインエディタを使うと、あなたのWebhookコードは<a href="https://firebase.google.com/docs/functions/" target="_blank">Cloud Functions for Firebase</a>を使ってクラウド内のマネージド環境にデプロイされます。</p>
<p>このWebhookコードは、<a href="https://github.com/actions-on-google/actions-on-google-nodejs" target="_blank">Actions on Google Node.js クライアントライブラリ</a>を使って、アシスタントがWebhookに送信するHTTPリクエストに応答しています。そのライブラリを使うことで、あなたは Dialogflow API のラッパーとして振る舞う <a href="https://actions-on-google.github.io/actions-on-google-nodejs/interfaces/dialogflow.dialogflowapp.html" target="_blank"><code>DialogflowApp</code></a> オブジェクトを作成することができます。</p>
<p>このコードラボでは、<code>DialogflowApp</code> オブジェクト型の <code>app</code> 変数を作成しています。</p>
<h2><strong>&#34;Default Welcome Intent&#34; インテントハンドラ関数を作成する</strong></h2>
<p><strong>index.js</strong> 内に、以下のコードを追加してください。追加場所は、コメント行が書かれている場所です。</p>
<h3><strong>&#34;Default Welcome Intent&#34; インテントハンドラ関数</strong></h3>
<pre><code>// &#34;Default Welcome Intent&#34;を処理するハンドラ関数の登録
app.intent(&#34;Default Welcome Intent&#34;, conv =&gt; {
    conv.ask(&#34;デイリーニュースをお伝えいたします。いつのニュースを聞きたいですか？&#34;);
    conv.ask(new Suggestions([&#34;最新のニュース&#34;, &#34;最近のニュース&#34;, &#34;昨日のニュース&#34;]));
});</code></pre>
<p><code>app.intent()</code> 関数は、インテントを処理するコールバックを宣言するために使用されます。この <code>app.intent()</code> 関数は、2つの重要な引数を受け取ります。</p>
<ul>
<li>インテント名: コールバックを登録する対象のインテント名を指定します。</li>
<li>コールバック関数: 呼び出されたインテントに対応して実行されるコールバック関数です。</li>
</ul>
<p>コールバック関数の第1引数には、以下の値が渡されます。</p>
<ul>
<li><a href="https://actions-on-google.github.io/actions-on-google-nodejs/classes/dialogflow.dialogflowconversation.html" target="_blank"><code>Dialogflow Conversation</code></a> オブジェクト（変数名: <code>conv</code> ）。これは、ダイアログの状態をクライアントライブラリで抽象化したものであり、現在アクティブなDialogflowコンテキスト、ユーザのデバイスのサーフェスで利用可能な機能など、Webhookへの着信要求の値を表すプロパティを含みます。</li>
</ul>
<p>Default Welcome Intentハンドラ関数では、以下の処理を行っています。</p>
<ul>
<li><code>conv.ask()</code> 関数に文字列を渡すことで、ユーザへの返事をGoogleアシスタントに渡しています。</li>
<li><code>conv.ask()</code> 関数に <a href="https://actions-on-google.github.io/actions-on-google-nodejs/classes/conversation_response.suggestions.html" target="_blank"><code>Suggestions</code></a> オブジェクトを渡すことで、ユーザへの返事と共に、Suggestion Chip をGoogleアシスタントに渡しています。</li>
</ul>
<p><a href="https://developers.google.com/actions/assistant/responses#suggestion_chip" target="_blank">Suggestion Chip</a> を使うことで、もしユーザが画面付きデバイスを利用している場合には、文字入力や発話をすることなく、タップするだけでGoogleアシスタントに問いかけができるようになります。具体的には、以下のように返事の吹き出しの下に、Suggestion Chipが表示されます。</p>
<p><img style="max-width: 313.16px" src="img/f85b4fd34ba0669c.png"></p>
<h2><strong>ニュースを提供する関数を作成する</strong></h2>
<p><strong>index.js</strong> 内に、以下のコードを追加してください。追加場所は、コメント行が書かれている場所です。</p>
<h3><strong>指定範囲のニュース一覧を取得する関数</strong></h3>
<pre><code>// 指定範囲のニュース一覧取得関数
const getNews = (start, end) =&gt; {
    return [
        {
            created: new Date(&#34;2018-09-24T09:00:00+0900&#34;),
            contents: &#34;夕方からゲリラ豪雨になる予報です。&#34;
        },
        {
            created: new Date(&#34;2018-09-24T22:30:00+0900&#34;),
            contents: &#34;明日19日の午前10時からJavaScript勉強会が社内で行われます。ぜひご参加ください。&#34;
        },
        {
            created: new Date(&#34;2018-09-25T10:00:00+0900&#34;),
            contents: &#34;ついに利用ユーザ数がのべ1億人を突破しました！&#34;
        }
    ].filter(x =&gt; {
        // 指定された範囲に限定する
        return (start &lt;= x.created.getTime()) &amp;&amp; (x.created.getTime() &lt;= end);
    }).sort((a, b) =&gt; {
        // ニュースの古い順に並び替える
        return a.created.getTime() - b.created.getTime();
    }).map(x =&gt; {
        // コンテンツだけ返す
        return x.contents;
    });
};</code></pre>
<p>本来であれば、ニュースはデータベースなどから動的に取得するべきですが、このコードラボでは固定的にニュース一覧を得るための <code>getNews()</code> 関数を作ることにします。上記のコードでは、3つのニュースを定義しています。ニュースの内容は自由で良いですが、 <code>created</code> で指定される日時は、以下を含めてください。それは、動作確認時に役に立ちます。</p>
<ul>
<li>今日の日付で、現在時刻から24時間以内。</li>
<li>昨日の日付で、現在時刻から24時間以内。</li>
<li>昨日の日付で、現在時刻から24時間よりも前の時刻。</li>
</ul>
<p>ここで、もう一つ便利な関数を追加します。いくつかのインテントを処理するコールバック関数からユーザに返事を送る際に、Suggestion Chipを含めます。何度もSuggestion Chipを指定するコードを書くのは良くないので、返事を送信するための <code>reply()</code> 関数を作りましょう。<strong>index.js</strong> 内に、以下のコードを追加してください。追加場所は、コメント行が書かれている場所です。</p>
<h3><strong>返事をする関数</strong></h3>
<pre><code>// 返事をする関数
const reply = (conv, message) =&gt; {
    conv.ask(message);
    conv.ask(new Suggestions([
        &#34;毎日受け取る&#34;, &#34;リアルタイムに受け取る&#34;,
        &#34;最新のニュース&#34;, &#34;最近のニュース&#34;, &#34;昨日のニュース&#34;
    ]));
};</code></pre>
<h2><strong>&#34;Recent News&#34; インテントハンドラ関数を作成する</strong></h2>
<p>では、ニュースを提供する関数を使って、各種インテントの処理を作成していきます。まずは、24時間以内のニュース一覧を伝えるための Recent News インテントハンドラ関数です。 <strong>index.js</strong> 内に、以下のコードを追加してください。追加場所は、コメント行が書かれている場所です。</p>
<h3><strong>&#34;Recent News&#34; インテントハンドラ関数</strong></h3>
<pre><code>// &#34;Recent News&#34;を処理するハンドラ関数の登録
app.intent(&#34;Recent News&#34;, conv =&gt; {
    // 24時間以内のニュースを得る
    const news = getNews(Date.now() - 24 * 60 * 60 * 1000, Date.now());
    // 返事をする
    if (news.length === 0) {
        reply(conv, &#34;最近のニュースは特にありません。いつのニュースを知りたいですか？&#34;);
    } else {
        reply(conv, `最近のニュースです。${news.join(&#34;&#34;)}以上です。いつのニュースを知りたいですか？`);
    }
});</code></pre>
<p>24時間以内にニュースがあるかどうかで、返事の内容を変化させています。</p>
<h2><strong>&#34;Latest News&#34; インテントハンドラ関数を作成する</strong></h2>
<p>次に、最新のニュース1件を伝えるための Latest News インテントハンドラ関数です。 <strong>index.js</strong> 内に、以下のコードを追加してください。追加場所は、コメント行が書かれている場所です。</p>
<h3><strong>&#34;Latest News&#34; インテントハンドラ関数</strong></h3>
<pre><code>// &#34;Latest News&#34;を処理するハンドラ関数の登録
app.intent(&#34;Latest News&#34;, conv =&gt; {
    // 24時間以内のニュースを得る
    const news = getNews(Date.now() - 24 * 60 * 60 * 1000, Date.now());
    if (news.length === 0) {
        reply(conv, &#34;最新のニュースは特にありません。いつのニュースを知りたいですか？&#34;);
    } else {
        reply(conv, `最新のニュースです。${news[news.length - 1]}いつのニュースを知りたいですか？`);
    }
});</code></pre>
<p>ここでは、24時間以内のニュースを最新のニュースの対象としています。</p>
<h2><strong>&#34;Past News&#34; インテントハンドラ関数を作成する</strong></h2>
<p>最後に、ユーザが指定した日付のニュースを伝えるための Past News インテントハンドラ関数です。 <strong>index.js</strong> 内に、以下のコードを追加してください。追加場所は、コメント行が書かれている場所です。</p>
<h3><strong>&#34;Past News&#34; インテントハンドラ関数</strong></h3>
<pre><code>// &#34;Past News&#34;を処理するハンドラ関数の登録
app.intent(&#34;Past News&#34;, (conv, {date}) =&gt; {
    // 指定日付のニュースを得る
    const start = new Date(date).setHours(0, 0, 0, 0);
    const news = getNews(start, start + 24 * 60 * 60 * 1000 - 1);
    // 返事をする
    if (news.length === 0) {
        reply(conv, &#34;その日のニュースは特にありません。いつのニュースを知りたいですか？&#34;);
    } else {
        reply(conv, `その日のニュースです。${news.join(&#34;&#34;)}以上です。いつのニュースを知りたいですか？`);
    }
});</code></pre>
<p>Recent News インテントハンドラ関数や Latest News インテントハンドラ関数と違って、Past News インテントハンドラ関数では、Dialogflowの解析結果を一つ受け取っています。先ほどは <code>conv</code> 引数一つのみでしたが、ここでは <code>{date}</code> という第2引数を指定しています。Past News インテントをDialogflow Consoleで登録した際に、 <code>@sys.date</code> エンティティの <code>date</code> パラメータが自動的に認識されたのを覚えていますか？ここでは、その認識された値を受け取り、ニュースの検索条件として利用しています。</p>
<p><img style="max-width: 602.00px" src="img/81f68007cc46c627.png"></p>
<p>Past News インテントハンドラ関数の記述が終わったら、 <strong>DEPLOY</strong> ボタンを押してコードをFirebaseにデプロイしてください。</p>
<h2><strong>動作確認する</strong></h2>
<p>ここまでの作業によって、デイリーニュースアクションは基本的な機能を提供することができるようになりました。ここで、Actions Console シミュレータを使って、実際に動作確認を行ってみましょう。</p>
<aside class="special"><p><strong>Tip:</strong> この<a href="https://developers.google.com/actions/tools/simulator" target="_blank">ガイド</a>では、Actions Console シミュレータの使用に関する最新情報を確認できます。以下にリストされた手順を実行して何らかの問題が発生した場合は、こちらを参照してください。</p>
</aside>
<p>Actions Console シミュレータであなたのアクションをテストするには、以下を行います:</p>
<ol type="1" start="1">
<li>左のナビゲーションの<a href="https://console.dialogflow.com/" target="_blank">Dialogflow Console</a>にて、<strong>Integrations</strong> をクリックします。その後、<strong>Google Assistant &gt; Integration Settings</strong> をクリックします。</li>
<li>あなたのActions projectを更新するために Test をクリックして、Actions Console シミュレータ内にそれを読み込みます。（もしあなたが &#34;Check auto-preview setting&#34; ダイアログに遭遇した場合は、&#34;Auto-preview changes&#34; オプションを有効にしたまま<strong>、Continue</strong> をクリックします。）</li>
</ol>
<p><img style="max-width: 602.00px" src="img/59dd8459ee98a1d3.png"></p>
<ol type="1" start="3">
<li>シミュレータにてあなたのアクションをテストするために、Input フィールド内に &#34;テスト用アプリにつないで&#34; とタイプして、Enterキーを叩きます。</li>
</ol>
<aside class="warning"><p>シミュレータの応答として &#34;こんにちは&#34; が表示された場合は、フルフィルメント内で何らかのエラーが発生した可能性があります。Dialogflowの <strong>Fulfillment</strong> 画面の下にあるリンクから、Cloud Functionsのログの中に何かエラーが出力されているかどうか確認してください。</p>
</aside>
<ol type="1" start="4">
<li>以下のフレーズを発言して、適切な返事がアクションから得られるかどうか確認をしてください。</li>
</ol>
<ul>
<li>&#34;今日のニュース&#34;</li>
<li>&#34;最近のニュース&#34;</li>
<li>&#34;最新のニュース&#34;</li>
<li>&#34;さようなら&#34;</li>
</ul>
<p><img style="max-width: 338.86px" src="img/2b8b6840bbf442c8.png"></p>
<p>ここまでで、デイリーニュースアクションの基本的な機能の実装が終わりました。</p>


      </google-codelab-step>
    
      <google-codelab-step label="Add Daily Updates" duration="15">
        <p>このセクションでは、デイリーニュースアクションに対して、Daily Updatesを追加します。ユーザが毎日指定の時間に最近のニュースに関する通知をDaily Updatesを使って受け取ることができるように機能追加を行います。</p>
<aside class="warning"><p>2019年9月27日現在、残念ながらDaily Updates機能を試すことができる環境は、Android deviceのみです。iOS向けに提供されているGoogleアシスタントアプリを含むその他の環境では、Daily Updatesを利用することができません。</p>
</aside>
<h2><strong>Daily Updatesの仕組みを理解する</strong></h2>
<p>アクションがDaily Updatesを利用することで、ユーザは毎日指定された時刻に通知を受け取ることができます。ユーザがその通知をタップすると、Googleアシスタントによってそのアクションが呼び出され、さらにアクションに含まれる特定のインテントがトリガーされます。</p>
<p><img style="max-width: 602.00px" src="img/9a7384025a2d857e.png"></p>
<p>Daily Updatesによってユーザにアクションから通知が行われる流れは、以下となります。</p>
<p><img style="max-width: 602.00px" src="img/6826c9e68e923b9.png"></p>
<ol type="1" start="1">
<li>ユーザがGoogleアシスタント経由でアクションに対して、Daily Updatesの登録を希望するフレーズを発話します。</li>
<li>アクションのフルフィルメントは、SDK が提供する <a href="https://actions-on-google.github.io/actions-on-google-nodejs/classes/conversation_question.registerupdate.html" target="_blank"><code>RegisterUpdate</code></a> クラスを使って、Daily Updatesの登録をActions on Googleに依頼します。</li>
<li>Googleアシスタントがユーザに対して、毎日何時に通知を受け取りたいかを問い合わせます。ユーザは時間を指示することで、Daily Updatesの登録が完了します。</li>
<li>ユーザが指定した時間付近で、Googleアシスタントはユーザのデバイスに対して、通知を送信します。</li>
<li>ユーザが通知が来ていることに気づき、その通知をタップします。タップ後、Googleアシスタントが起動します。</li>
<li>Googleアシスタントは、通知内容に基づいて、アクションを呼び出します。そして、(2)で指定されたインテントがトリガーされます。</li>
<li>アクションはインテントハンドラ関数から返事をします。</li>
</ol>
<p>このコードラボでは、最近のニュースを伝える Recent News インテントをDaily Updatesとして登録できるようにします。</p>
<h2><strong>Daily Updatesを登録するインテントを追加する</strong></h2>
<p>最初に、ユーザが最近のニュースを毎日受け取りたいことを伝えるためのインテントをDialogflowに追加します。Dialogflow Consoleにて以下の操作を行ってください。</p>
<ol type="1" start="1">
<li>左のナビゲーションメニューにある <strong>Intents</strong> メニュー項目の右にある<strong>＋</strong>アイコンをクリックします。</li>
<li><strong>Intent name</strong> に &#34;Setup Daily Updates&#34; と入力します。</li>
<li><strong>Training phrases</strong> に以下を入力します。</li>
</ol>
<ul>
<li>&#34;毎日受け取る&#34;</li>
<li>&#34;毎日ニュースを受け取る&#34;</li>
<li>&#34;毎日ニュースを教えて&#34;</li>
<li>&#34;毎日教えて&#34;</li>
</ul>
<p><img style="max-width: 602.00px" src="img/860a7025649df0ca.png"></p>
<ol type="1" start="4">
<li>下にある <strong>Fulfillment </strong>をクリックして、フルフィルメントを設定するためのUIを表示します。そして、<strong>Enable webhook call for this intent</strong> を ON にします。</li>
<li>上にある <strong>SAVE</strong> ボタンを押して、変更内容を保存します。</li>
</ol>
<h2><strong>&#34;Setup Daily Updates&#34; インテントハンドラ関数を作成する</strong></h2>
<p>次に、Daily Updatesを登録する処理を行う Setup Daily Updates インテントハンドラ関数を追加します。 <strong>index.js</strong> 内に、以下のコードを追加してください。追加場所は、コメント行が書かれている場所です。</p>
<h3><strong>&#34;Setup Daily Updates&#34; インテントハンドラ関数</strong></h3>
<pre><code>// &#34;Setup Daily Updates&#34;を処理するハンドラ関数の登録
app.intent(&#34;Setup Daily Updates&#34;, conv =&gt; {
    // Daily Updatesの登録を要求する
    conv.ask(new RegisterUpdate({
        intent: &#34;Recent News&#34;,
        frequency: &#34;DAILY&#34;
    }));
});</code></pre>
<p>Daily Updatesを登録するために、SDK が提供する <a href="https://actions-on-google.github.io/actions-on-google-nodejs/classes/conversation_question.registerupdate.html" target="_blank"><code>RegisterUpdate</code></a> クラスを使います。その際に、以下の情報を与えます。</p>
<ul>
<li><code>intent</code> - ユーザが通知をタップした際にトリガーされるインテントの名前を指定します。</li>
<li><code>frequency</code> - Daily Updatesを示す &#34;DAILY&#34; 文字列を指定します。</li>
</ul>
<p>これにより、Googleアシスタントがアクションの代わりにユーザに指定時刻を問い合わせします。</p>
<h2><strong>Daily Updatesの登録結果を受け取るインテントを追加する</strong></h2>
<p>ユーザがGoogleアシスタントに時刻を指定した後に、Actions on Googleはアクションに <code>actions_intent_REGISTER_UPDATE</code> イベントを送信します。このイベントを受け取るためのインテントをDialogflowに追加します。Dialogflow Consoleにて以下の操作を行ってください。</p>
<ol type="1" start="1">
<li>左のナビゲーションメニューにある <strong>Intents</strong> メニュー項目の右にある<strong>＋</strong>アイコンをクリックします。</li>
<li><strong>Intent name</strong> に &#34;Finish Daily Updates Setup&#34; と入力します。</li>
<li><strong>Events</strong> に &#34;actions_intent_REGISTER_UPDATE&#34; と入力します。</li>
</ol>
<p><img style="max-width: 602.00px" src="img/d58e03da3cfc19f8.png"></p>
<ol type="1" start="4">
<li>下にある <strong>Fulfillment </strong>をクリックして、フルフィルメントを設定するためのUIを表示します。そして、<strong>Enable webhook call for this intent</strong> を ON にします。</li>
<li>上にある <strong>SAVE</strong> ボタンを押して、変更内容を保存します。</li>
</ol>
<h2><strong>&#34;Finish Daily Updates Setup&#34; インテントハンドラ関数を作成する</strong></h2>
<p>フルフィルメントにて <code>actions_intent_REGISTER_UPDATE</code> イベントを処理する関数を追加します。 <strong>index.js</strong> 内に、以下のコードを追加してください。追加場所は、コメント行が書かれている場所です。</p>
<h3><strong>&#34;Finish Daily Updates Setup&#34; インテントハンドラ関数</strong></h3>
<pre><code>// &#34;Finish Daily Updates Setup&#34;を処理するハンドラ関数の登録
app.intent(&#34;Finish Daily Updates Setup&#34;, (conv, params, registered) =&gt; {
    if (registered &amp;&amp; registered.status === &#34;OK&#34;) {
        conv.close(&#34;毎日ご指定の時間にニュースをお届けいたします。また会いましょう。&#34;);
    } else {
        reply(conv, &#34;気が向いたら登録してください。いつのニュースを知りたいですか？&#34;);
    }
});</code></pre>
<p>Daily Updates が正しく登録されたかどうかは、 <code>app.intent()</code> 関数の第2引数で渡しているコールバック関数の第3引数として渡される値を見ることで判断することができます。上記のコードでは、 <code>registered</code> という引数です。この値が undefined ではなく、 status 値として &#34;OK&#34; がセットされていれば、Daily Updates が登録されたことになります。</p>
<p>もしDaily Updatesが登録されていれば、 <code>conv.close()</code> 関数を使って、返事をすると同時に会話を終了します。</p>
<h2><strong>Recent News インテントをDaily Updatesとして登録する</strong></h2>
<p>Daily Updates機能を使ってユーザに通知を送信するためには、Actions on Google Consoleにて、インテントをDaily Updateの対象として登録することが必要です。登録を行うために、以下の操作を行います。</p>
<ol type="1" start="1">
<li>左のナビゲーションの<a href="https://console.dialogflow.com/" target="_blank">Dialogflow Console</a>にて、<strong>Integrations</strong> をクリックします。その後、<strong>Google Assistant &gt; Integration Settings</strong> をクリックします。</li>
<li><strong>Implicit invocation</strong> の <strong>Add intent</strong> フィールドに &#34;Recent News&#34; と入力して Enter キーを押します。</li>
</ol>
<p><img style="max-width: 602.00px" src="img/b17f81e1dffef2fb.png"></p>
<ol type="1" start="3">
<li><strong>TEST</strong> をクリックします。これにより、新規タブにて Actions on Google Console が開きます。</li>
<li>Actions on Google Consoleの左にあるナビゲーションメニューから <strong>Actions</strong> をクリックします。その後、右の一覧から <strong>Recent News</strong> の行をクリックします。</li>
</ol>
<p><img style="max-width: 602.00px" src="img/94520dbc2d0f9207.png"></p>
<ol type="1" start="5">
<li>ページの下にある <strong>Would you like to offer daily updates to users?</strong> を ON に変更します。そして、 <strong>Content title</strong> フィールドに &#34;デイリーニュース&#34; と入力します。この文字列は、通知に含まれます。</li>
</ol>
<p><img style="max-width: 602.00px" src="img/c2390b615471e8d1.png"></p>
<ol type="1" start="6">
<li>ページの右上にある <strong>SAVE</strong> ボタンを押します。</li>
</ol>
<h2><strong>Daily Updatesの動作確認をする</strong></h2>
<p>では、Daily Updatesの動作確認を行いましょう。Actions on GoogleのActions シミュレータではなく、スマートフォンにて動作確認を行ってください。動作確認の手順は、以下となります。</p>
<ol type="1" start="1">
<li>スマートフォン上で、Googleアシスタントを起動します。そして、&#34;テスト用アプリにつないで&#34; と話しかけて、アクションを呼び出します。アクションから、ウェルカムメッセージが届きます。</li>
<li>&#34;毎日受け取る&#34; と話しかけます。</li>
<li>Googleアシスタントが通知を送信する時刻を聞いてきますので、以下の例のように、現在時刻から10分以上先の時間を回答します。</li>
</ol>
<ul>
<li>&#34;午後4時30分&#34;</li>
<li>&#34;16時45分&#34;</li>
<li>&#34;4:30am&#34;</li>
<li>&#34;16:45&#34;</li>
</ul>
<ol type="1" start="4">
<li>時間になるまで待ちます。</li>
<li>通知がスマートフォンに届いたら、その通知をタップします。</li>
</ol>
<aside class="warning"><p>通知は、指定した時刻通りに届くこともあれば、数分遅れて届く場合もあります。時間になっても届かない場合は、数分待ってみてください。</p>
</aside>
<p>通知を解除する場合は、受け取った通知にある「停止」をタップします。これにより、Googleアシスタントは通知を止めて良いかどうか聞いてきますので、&#34;はい&#34; と答えてください。</p>


      </google-codelab-step>
    
      <google-codelab-step label="Request Push Notifications permission" duration="15">
        <p>ここからは、デイリーニュースアクションに対して、Push Notificationsを追加します。ユーザに最新のニュースをリアルタイムで通知する機能をPush Notificationsを使って実現します。</p>
<h2><strong>Push Notificationsの仕組みを理解する</strong></h2>
<p>Push Notifications機能を利用することで、通知をユーザにいつでも送信することができます。ただし、通知の送信は、ユーザから許諾を得た後に可能となります。ユーザが受け取った通知をタップすると、Googleアシスタントによってそのアクションが呼び出され、さらにアクションに含まれる特定のインテントがトリガーされます。</p>
<p><img style="max-width: 602.00px" src="img/62db770ce6eca64.png"></p>
<p>Push Notificationsによってユーザにアクションから通知が行われる流れは、以下となります。</p>
<p><img style="max-width: 602.00px" src="img/6ae62bb6204186e8.png"></p>
<ol type="1" start="1">
<li>ユーザがGoogleアシスタント経由でアクションに対して、Push Notificationsを希望するフレーズを発話します。</li>
<li>アクションのフルフィルメントは、SDK が提供する <a href="https://actions-on-google.github.io/actions-on-google-nodejs/classes/conversation_question.updatepermission.html" target="_blank"><code>UpdatePermission</code></a> クラスを使って、Push Notificationsによる通知の許可をActions on Googleに依頼します。</li>
<li>Googleアシスタントがユーザに対して、通知の許諾を問い合わせます。ユーザは許諾するかどうか返事を行います。</li>
<li>ユーザが許諾した場合、アクションは Actions API を使って通知を送信します。通知は、ユーザのスマートフォンに届きます。</li>
<li>ユーザが通知が来ていることに気づき、その通知をタップします。タップ後、Googleアシスタントが起動します。</li>
<li>Googleアシスタントは、通知内容に基づいて、アクションを呼び出します。そして、(2)で指定されたインテントがトリガーされます。</li>
<li>アクションはインテントハンドラ関数から返事をします。</li>
</ol>
<p>このコードラボでは、最新のニュースを伝える Latest News インテントをPush Notificationsにより通知できるようにします。このセクションでは、最初にユーザに通知を送信することを許諾してもらうために必要な機能を追加します。</p>
<h2><strong>Push Notificationsを希望するインテントを追加する</strong></h2>
<p>最初に、ユーザが最新のニュースをリアルタイムで受け取りたいことを伝えるためのインテントをDialogflowに追加します。Dialogflow Consoleにて以下の操作を行ってください。</p>
<ol type="1" start="1">
<li>左のナビゲーションメニューにある <strong>Intents</strong> メニュー項目の右にある<strong>＋</strong>アイコンをクリックします。</li>
<li><strong>Intent name</strong> に &#34;Setup Push Notifications&#34; と入力します。</li>
<li><strong>Training phrases</strong> に以下を入力します。</li>
</ol>
<ul>
<li>&#34;リアルタイムに受け取る&#34;</li>
<li>&#34;リアルタイム&#34;</li>
<li>&#34;すぐに受け取る&#34;</li>
</ul>
<p><img style="max-width: 602.00px" src="img/d237e5e0e2e0598d.png"></p>
<ol type="1" start="4">
<li>下にある <strong>Fulfillment </strong>をクリックして、フルフィルメントを設定するためのUIを表示します。そして、<strong>Enable webhook call for this intent</strong> を ON にします。</li>
<li>上にある <strong>SAVE</strong> ボタンを押して、変更内容を保存します。</li>
</ol>
<h2><strong>&#34;Setup Push Notifications&#34; インテントハンドラ関数を作成する</strong></h2>
<p>次に、Push Notificationsを希望する処理を行う Setup Push Notifications インテントハンドラ関数を追加します。 <strong>index.js</strong> 内に、以下のコードを追加してください。追加場所は、コメント行が書かれている場所です。</p>
<h3><strong>&#34;Setup Push Notifications&#34; インテントハンドラ関数</strong></h3>
<pre><code>// &#34;Setup Push Notifications&#34;を処理するハンドラ関数の登録
app.intent(&#34;Setup Push Notifications&#34;, conv =&gt; {
    conv.ask(new UpdatePermission({
        intent: &#34;Latest News&#34;
    }));
});</code></pre>
<p>Push Notificationsによる通知の送信についてユーザから許諾を得るために、SDK が提供する <a href="https://actions-on-google.github.io/actions-on-google-nodejs/classes/conversation_question.updatepermission.html" target="_blank"><code>UpdatePermission</code></a> クラスを使います。その際に、以下の情報を与えます。</p>
<ul>
<li><code>intent</code> - ユーザが通知をタップした際にトリガーされるインテントの名前を指定します。</li>
</ul>
<p>これにより、Googleアシスタントがアクションの代わりにユーザに通知を送信して良いかどうかの問い合わせを行います。</p>
<h2><strong>Push Notificationsの許諾結果を受け取るインテントを追加する</strong></h2>
<p>ユーザがGoogleアシスタントに許諾するかどうかを返答した後に、Actions on Googleはアクションに <code>actions_intent_PERMISSION</code> イベントを送信します。このイベントを受け取るためのインテントをDialogflowに追加します。Dialogflow Consoleにて以下の操作を行ってください。</p>
<ol type="1" start="1">
<li>左のナビゲーションメニューにある <strong>Intents</strong> メニュー項目の右にある<strong>＋</strong>アイコンをクリックします。</li>
<li><strong>Intent name</strong> に &#34;Finish Push Notifications Setup&#34; と入力します。</li>
<li><strong>Events</strong> に &#34;actions_intent_PERMISSION&#34; と入力します。</li>
</ol>
<p><img style="max-width: 602.00px" src="img/2a53471473e0dad.png"></p>
<ol type="1" start="4">
<li>下にある <strong>Fulfillment </strong>をクリックして、フルフィルメントを設定するためのUIを表示します。そして、<strong>Enable webhook call for this intent</strong> を ON にします。</li>
<li>上にある <strong>SAVE</strong> ボタンを押して、変更内容を保存します。</li>
</ol>
<h2><strong>&#34;Finish Push Notifications Setup&#34; インテントハンドラ関数を作成する</strong></h2>
<p>フルフィルメントにて <code>actions_intent_PERMISSION</code> イベントを処理する関数を追加します。 <strong>index.js</strong> 内に、以下のコードを追加してください。追加場所は、コメント行が書かれている場所です。</p>
<h3><strong>&#34;Finish Push Notifications Setup&#34; インテントハンドラ関数</strong></h3>
<pre><code>// &#34;Finish Push Notifications Setup&#34;を処理するハンドラ関数の登録
app.intent(&#34;Finish Push Notifications Setup&#34;, (conv, params, granted) =&gt; {
    if (granted) {
        const userId = conv.arguments.get(&#34;UPDATES_USER_ID&#34;);
        console.log(&#34;userId&#34;, userId);
        conv.close(&#34;ニュースをすぐにお届けいたします。また会いましょう。&#34;);
    } else {
        reply(conv, &#34;気が向いたら登録してください。いつのニュースを知りたいですか？&#34;);
    }
});</code></pre>
<p>Push Notifications による通知の送信をユーザが許可したかどうかは、 <code>app.intent()</code> 関数の第2引数で渡しているコールバック関数の第3引数として渡される値を見ることで判断することができます。上記のコードでは、 <code>granted</code> という引数です。この値が undefined ではなければ、ユーザが通知の送信を許可したことになります。</p>
<p>ここで、 <code>conv.arguments.get(&#34;UPDATES_USER_ID&#34;)</code> という処理を行うことで、通知の送信を許可したユーザのID文字列を取得しています。本来であれば、この値をデータベースに格納するなどが必要ですが、このコードラボではログに出力しています。この値は、後ほどActions APIを使って通知を送信する際に必要となります。</p>
<p>もし通知の送信が許可されていれば、 <code>conv.close()</code> 関数を使って、返事をすると同時に会話を終了します。</p>
<h2><strong>Latest News インテントをPush Notificationsとして登録する</strong></h2>
<p>Push Notifications機能を使ってユーザに通知を送信するためには、Actions on Google Consoleにて、インテントをPush Notificationsの対象として登録することが必要です。登録を行うために、以下の操作を行います。</p>
<ol type="1" start="1">
<li>左のナビゲーションの<a href="https://console.dialogflow.com/" target="_blank">Dialogflow Console</a>にて、<strong>Integrations</strong> をクリックします。その後、<strong>Google Assistant &gt; Integration Settings</strong> をクリックします。</li>
<li><strong>Implicit invocation</strong> の <strong>Add intent</strong> フィールドに &#34;Latest News&#34; と入力して Enter キーを押します。</li>
</ol>
<p><img style="max-width: 602.00px" src="img/165f89ceda453abd.png"></p>
<ol type="1" start="3">
<li><strong>TEST</strong> をクリックします。これにより、新規タブにて Actions on Google Console が開きます。</li>
<li>Actions on Google Consoleの左にあるナビゲーションメニューから <strong>Actions</strong> をクリックします。その後、右の一覧から <strong>Latest News</strong> の行をクリックします。</li>
</ol>
<p><img style="max-width: 602.00px" src="img/dc04dc556e598d9e.png"></p>
<ol type="1" start="5">
<li>ページの下にある <strong>Would you like to send push notifications? If yes, user permission will be needed.</strong> を ON に変更します。そして、 <strong>Content title</strong> フィールドに &#34;最新のニュース&#34; と入力します。この文字列は、通知に含まれます。</li>
</ol>
<p><img style="max-width: 602.00px" src="img/4d90ebeac9c7a3da.png"></p>
<ol type="1" start="6">
<li>ページの右上にある <strong>SAVE</strong> ボタンを押します。</li>
</ol>
<h2><strong>Push Notificationsのユーザ許諾の動作確認をする</strong></h2>
<p>では、Push Notificationsを使って通知を行うために必要となるユーザ許諾について、動作確認を行いましょう。このコードラボでは、Daily Updatesの時と同じように、スマートフォンにて動作確認を行いましょう（実際にはActions シミュレータでも大丈夫です）。動作確認の手順は、以下となります。</p>
<ol type="1" start="1">
<li>スマートフォン上で、Googleアシスタントを起動します。そして、&#34;テスト用アプリにつないで&#34; と話しかけて、アクションを呼び出します。アクションから、ウェルカムメッセージが届きます。</li>
<li>&#34;リアルタイムに受け取る&#34; と話しかけます。</li>
<li>Googleアシスタントが通知を送信して良いかどうか問い合わせをしてくるので、&#34;はい&#34; と返事をします。</li>
</ol>
<p>ここで、通知の送信を許諾したユーザのID文字列をログから見つけます。以下の操作を行ってください。</p>
<ol type="1" start="1">
<li>Dialogflowの Fulfillment のページの下にある <strong>View execution logs in the Firebase console</strong> というリンクをクリックします。新規タブでCloud Functions for Firebaseのログ画面が表示されます。</li>
<li><code>userId: ...</code> という行を探します。そこに書かれている文字列が対象ユーザのID文字列です。これをメモしておきます。</li>
</ol>
<p><img style="max-width: 602.00px" src="img/d3a49ddf9dc9f01c.png"></p>
<p>Push Notificationsによる通知の送信を許諾したユーザのID文字列を得ることができれば、実際に通知を送信することが可能です。</p>


      </google-codelab-step>
    
      <google-codelab-step label="Send Push Notification" duration="15">
        <p>このセクションでは、先ほど通知の送信を許可したユーザ向けに、実際に通知を送信するための機能を作成します。このコードラボでは、通知の送信処理について、フルフィルメントとしてではなく、単独のJavaScriptファイルとして作成します。</p>
<aside class="special"><p><strong>Tip:</strong> 通知処理を実行するために、あなたは <a href="https://nodejs.org/en/" target="_blank">Node.js</a> に通常含まれる <a href="https://www.npmjs.com/" target="_blank">npm</a> をインストールする必要があります。</p>
</aside>
<h2><strong>Actions APIを利用可能にする</strong></h2>
<p>Push Notificationsを使って通知を送信する際には、Actions APIを利用します。Actions on GoogleやDialogflowにプロジェクトを作っただけでは、Actions APIを使うことはできません。Google Cloud Platformにて、Actions APIを利用可能に設定する必要があります。</p>
<p>以下の操作を行って、Actions APIを有効にしてください。</p>
<ol type="1" start="1">
<li>Dialogflowの左にあるナビゲーションメニューには、Dialogflowエージェント名と共に歯車のアイコンがあります。そのアイコンをクリックして、設定画面を開きます。</li>
</ol>
<p><img style="max-width: 602.00px" src="img/4fb68235d4f1748a.png"></p>
<ol type="1" start="2">
<li><strong>GOOGLE PROJECT</strong> にある <strong>Google Cloud</strong> リンクをクリックします。新規タブにて、Google Cloud PlatformのConsoleが開きます。ヘッダにあるプロジェクト名が &#34;daily-news-codelab&#34; が選択されていることを確認してください。</li>
</ol>
<p><img style="max-width: 602.00px" src="img/1b2c4ce056121d9.png"></p>
<ol type="1" start="3">
<li>左上のハンバーガーメニューボタンをクリックして、その中にある <strong>APIとサービス</strong> をクリックします。そして、 <strong>ダッシュボード</strong> を選択します。</li>
</ol>
<p><img style="max-width: 602.00px" src="img/695d039d5f95a298.png"></p>
<ol type="1" start="4">
<li>ページ上部にある <strong>APIとサービスの有効化</strong> をクリックします。</li>
<li><strong>APIとサービスを検索</strong> フィールドに、&#34;Actions API&#34; と入力します。すると、APIの候補が表示されるので、その中から &#34;Actions API&#34; をクリックします。</li>
</ol>
<p><img style="max-width: 602.00px" src="img/f6a4e3e2eaa189ca.png"></p>
<ol type="1" start="6">
<li>Actions APIの説明ページにある <strong>有効にする</strong> ボタンをクリックします。</li>
</ol>
<p><img style="max-width: 602.00px" src="img/dd4262e01444fdfc.png"></p>
<p>Actions APIが有効になった後に、Actions APIのダッシュボード画面が表示されます。</p>
<h2><strong>サービスアカウントキーを発行する</strong></h2>
<p>通知を送信するためのActions APIを利用するために、Google Cloud Platformにてサービスアカウントキーを発行します。発行されたサービスアカウントキーにより、Actions APIを利用するためのクライアント認証が行われます。</p>
<p>以下の操作を行って、サービスアカウントキーを発行してください。</p>
<ol type="1" start="1">
<li>Google Cloud Platformの左上のハンバーガーメニューボタンをクリックして、その中にある <strong>APIとサービス</strong> をクリックします。そして、 <strong>認証情報</strong> を選択します。</li>
</ol>
<p><img style="max-width: 602.00px" src="img/97328f3d71e5bb5b.png"></p>
<ol type="1" start="2">
<li><strong>認証情報を作成</strong> プルダウンメニューから、 <strong>サービスアカウント</strong> を選択します。</li>
</ol>
<p><img style="max-width: 602.00px" src="img/2e33cc8c43897f3b.png"></p>
<ol type="1" start="3">
<li><strong>サービスアカウント</strong> として &#34;新しいサービスアカウント&#34; を選択し、以下の内容を入力します。</li>
</ol>
<ul>
<li>サービスアカウント名: &#34;notifications&#34;</li>
<li>役割: オーナー</li>
<li>キーのタイプ: JSON</li>
</ul>
<p><img style="max-width: 602.00px" src="img/38689ac15bb7227f.png"></p>
<ol type="1" start="4">
<li><strong>作成</strong> ボタンをクリックします。JSONファイルのダウンロードが開始されるので、保存先を選択します。</li>
</ol>
<h2><strong>Node.jsプロジェクトを作成する</strong></h2>
<p>ここからは、通知を送信するためのJavaScriptファイルの作成に取りかかります。まずは、以下の手順を行って、ディレクトリを作成して、Node.jsプロジェクトを開始します。</p>
<ol type="1" start="1">
<li>ターミナル内で、任意の場所に <code>daily-news-codelab</code> ディレクトリを作成して、その中に移動します。</li>
</ol>
<pre><code>mkdir daily-news-codelab
cd daily-news-codelab</code></pre>
<ol type="1" start="2">
<li><code>npm</code> コマンドを使って、Node.jsプロジェクトを作成します。いくつか質問されますが、全て Enter キーを押して回答します。</li>
</ol>
<pre><code>npm init</code></pre>
<ol type="1" start="3">
<li>依存ライブラリとして、 googleapis および request をインストールします。</li>
</ol>
<pre><code>npm install googleapis --save
npm install request --save</code></pre>
<h2><strong>通知を送信するJavaScriptファイルを作成する</strong></h2>
<p>Node.jsプロジェクトの準備が整いました。手元に以下があることを確認してください。</p>
<ul>
<li>通知を送信するユーザのID文字列</li>
<li>サービスアカウントキーのJSONファイル</li>
</ul>
<p>先ほど作成した <code>daily-news-codelab</code> ディレクトリ内に、以下の内容で <code>send-notification.js</code> という名前でファイルを作成してください。</p>
<h3><strong>send-notification.js</strong></h3>
<pre><code>&#34;use strict&#34;;

const {google} = require(&#34;googleapis&#34;);
const key = require(&#34;&lt;SERVICE_ACCOUNT_KEY_JSON_FILE_PATH&gt;&#34;);
const request = require(&#34;request&#34;);

const jwtClient = new google.auth.JWT(
    key.client_email,
    null,
    key.private_key,
    [
        &#34;https://www.googleapis.com/auth/actions.fulfillment.conversation&#34;
    ],
    null
);

jwtClient.authorize((err, tokens) =&gt; {
    const options = {
        userNotification: {
            title: process.argv[2]
        },
        target: {
            userId: &#34;&lt;TARGET_USER_ID&gt;&#34;,
            intent: &#34;Latest News&#34;,
            locale: &#34;ja-JP&#34;
        }
    };
    request.post(&#34;https://actions.googleapis.com/v2/conversations:send&#34;, {
        auth: {
            &#34;bearer&#34;: tokens.access_token
        },
        json: true,
        body: {
            customPushMessage: options
       }
    }, (err, response, body) =&gt; {
       console.log(response.statusCode + &#34;:&#34; + response.statusMessage);
    });
});</code></pre>
<p><code>send-notification.js</code> ファイルの中に、修正すべき箇所が2つあります。以下の内容で修正を行ってください。</p>
<ul>
<li><code>&lt;SERVICE_ACCOUNT_KEY_JSON_FILE_PATH&gt;</code> - サービスアカウントキーのJSONファイル</li>
<li><code>&lt;TARGET_USER_ID&gt;</code> - 通知を送信するユーザのID文字列</li>
</ul>
<p>コードの前半部分は、サービスアカウントキーのJSONファイルの内容を読み込み、アクセストークンを得るための処理となります。その後、 <code>request()</code> 関数を使って、Actions API のエンドポイントに対して、通知を送信するために必要となる情報を渡しています。具体的には、以下の内容を指定します。</p>
<ul>
<li>body.customPushMessage.userNotification.title - 通知のタイトル文字列。</li>
<li>body.customPushMessage.target.userId - 通知を送信するユーザのID文字列。</li>
<li>body.customPushMessage.target.intent - 通知をタップした際にトリガーするインテントの名前。</li>
<li>body.customPushMessage.target.locale - 国と言語（IETF BCP-47）。</li>
</ul>
<p>通知のタイトル文字列は、 <code>process.argv[2]</code> として、 <code>send-notification.js</code> ファイルを実行する際のコマンドライン引数として渡すことができるようにしています。</p>
<h2><strong>通知を送信する</strong></h2>
<p>ターミナル内で以下のコマンドを実行してください。</p>
<pre><code>node send-notification.js &#34;ユーザ数1億人突破!&#34;</code></pre>
<p>以下のように表示されれば、通知の送信依頼が正常に受け付けられたことになります。</p>
<pre><code>200:OK</code></pre>
<p>スマートフォンに通知が来ていることを確認してください。そして、通知をタップしてください。</p>
<aside class="warning"><p>通知は、数分遅れて届く場合があります。すぐに届いていなくても、数分待ってみてください。</p>
</aside>
<p>通知を解除する場合は、受け取った通知にある「停止」をタップします。これにより、Googleアシスタントは通知を止めて良いかどうか聞いてきますので、&#34;はい&#34; と答えてください。</p>
<aside class="warning"><p>もし <code>200</code> 以外の数値が表示された場合は、何らかのエラーが発生している可能性があります。以下の点について確認をしてください。</p>
<ul>
<li>Push Notifications機能を使って通知を送信して良いかどうかをGoogleアシスタントから許可したかどうか。</li>
<li>ユーザのID文字列が正しく <code>send-notification.js</code> ファイルに記載されているかどうか。</li>
<li>サービスアカウントキーのJSONファイルのパスが正しいかどうか。</li>
<li>受け取った通知の <strong>停止</strong> をタップして、通知の送信許可を取り消していたかどうか。</li>
</ul>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Next steps" duration="1">
        <p><strong>おめでとうございます！</strong></p>
<p>あなたは今、Actions on Googleを使った会話型のユーザインタフェースを構築して、ユーザに積極的に通知を送信してUser Engagementを高める機能を追加する方法を知ることができました。</p>
<h2 class="checklist"><strong>What we&#39;ve covered</strong></h2>
<ul class="checklist">
<li>Daily Updatesを使った毎日指定された時刻にユーザが通知を受け取ることができる仕組みの理解と組み込み方法。</li>
<li>Push Notificationsを使ったリアルタイムな通知の送信方法。</li>
</ul>
<h2><strong>次は何ですか？</strong></h2>
<p>Daily UpdatesおよびPush Notificationsの使い方を学ぶために、Googleはよりリッチなコードサンプルを提供しています。</p>
<ul>
<li><a href="https://github.com/actions-on-google/actionssdk-updates-nodejs" target="_blank">actions-on-google/actionssdk-updates-nodejs</a></li>
<li><a href="https://github.com/actions-on-google/dialogflow-updates-nodejs" target="_blank">actions-on-google/dialogflow-updates-nodejs</a></li>
</ul>
<p>Actions on Googleについて学ぶために、以下のリソースについても参考にすることができます:</p>
<ul>
<li><a href="http://actions.google.com/" target="_blank">actions.google.com</a>: Actions on Googleの公式ドキュメントサイトです。</li>
<li><a href="https://github.com/actions-on-google/" target="_blank">Actions on Google GitHub repo</a>: サンプルコードとライブラリがあります。</li>
<li><a href="https://dialogflow.com/" target="_blank">Dialogflow.com</a>: Dialogflowの公式ドキュメントサイトです。</li>
</ul>
<p>Twitter <a href="https://twitter.com/ActionsOnGoogle" target="_blank">@ActionsOnGoogle</a> をフォローしてください。また、あなたが開発したものを <a href="https://twitter.com/hashtag/AoGDevs?src=hash" target="_blank">#AoGDevs</a> にてシェアしてください。</p>
<h2><strong>Feedback survey</strong></h2>
<p>次に行く前に、<a href="https://goo.gl/forms/SLcedXyVSNl7RkUc2" target="_blank">このフォーム</a>を使って私たちにフィードバックを送ってください！</p>


      </google-codelab-step>
    
  </google-codelab>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-49880327-14', 'auto');

    (function() {
      var gaCodelab = '';
      if (gaCodelab) {
        ga('create', gaCodelab, 'auto', {name: 'codelab'});
      }

      var gaView;
      var parts = location.search.substring(1).split('&');
      for (var i = 0; i < parts.length; i++) {
        var param = parts[i].split('=');
        if (param[0] === 'viewga') {
          gaView = param[1];
          break;
        }
      }
      if (gaView && gaView !== gaCodelab) {
        ga('create', gaView, 'auto', {name: 'view'});
      }
    })();
  </script>

</body>
</html>
